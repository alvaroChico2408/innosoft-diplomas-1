from flask import render_template, redirect, url_for, request
from flask_login import login_required

from app.modules.profile import profile_bp
from app.modules.auth.services import AuthenticationService
from app.modules.profile.forms import UserProfileForm
from app.modules.profile.services import UserProfileService


@profile_bp.route("/profile/edit", methods=["GET", "POST"])
@login_required
def edit_profile():
    auth_service = AuthenticationService()
    profile = auth_service.get_authenticated_user_profile()
    if not profile:
        return redirect(url_for("public.index"))

    # Mantener el campo de contraseña vacío al cargar el formulario
    form = UserProfileForm(
        name=profile.name,
        surname=profile.surname,
        email=profile.email,
        password=""  # Dejar vacío para no mostrar la contraseña almacenada
    )
    
    if request.method == "POST":
        service = UserProfileService()
        result, errors = service.update_profile(profile.id, form)
        return service.handle_service_response(
            result, errors, "profile.edit_profile", "Profile updated successfully", "profile/edit.html", form
        )

    return render_template("profile/edit.html", form=form, profile=profile)

